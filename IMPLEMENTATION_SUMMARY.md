# Cloudflare API æˆæœ¬è¿½è¸ªåŠŸèƒ½å®æ–½æ€»ç»“

## âœ… å®æ–½å®Œæˆ

**æ—¥æœŸ**: 2025-10-28  
**ç›®æ ‡**: æ·»åŠ å®Œæ•´çš„æ¨¡å‹æ”¯æŒå’Œæˆæœ¬è¿½è¸ªåŠŸèƒ½  
**çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

---

## ğŸ¯ å®æ–½å†…å®¹

### 1. æ‰©å±•æ¨¡å‹åˆ—è¡¨ï¼ˆ5ä¸ª â†’ 15ä¸ªï¼‰

**æ–‡ä»¶**: `server/cloudflare_client.py`

æ·»åŠ äº†15ä¸ª Cloudflare Workers AI æ¨¡å‹ï¼ŒæŒ‰æä¾›å•†åˆ†ç»„ï¼š

| æä¾›å•† | æ¨¡å‹æ•° | ä»·æ ¼èŒƒå›´ |
|-------|-------|---------|
| **Meta** | 3ä¸ª | $0.04-0.05/M tokens |
| **Mistral AI** | 2ä¸ª | $0.06/M tokens |
| **Alibaba (Qwen)** | 2ä¸ª | $0.05-0.08/M tokens |
| **Microsoft** | 1ä¸ª | $0.03/M tokens |
| **Google** | 2ä¸ª | $0.02-0.05/M tokens |
| **DeepSeek AI** | 1ä¸ª | $0.07/M tokens |
| **OpenChat** | 1ä¸ª | $0.05/M tokens |
| **TinyLlama** | 1ä¸ª | $0.01/M tokens (æœ€ä¾¿å®œ) |
| **TII** | 1ä¸ª | $0.05/M tokens |
| **Intel** | 1ä¸ª | $0.05/M tokens |

### 2. å®šä»·é…ç½®

æ¯ä¸ªæ¨¡å‹éƒ½é…ç½®äº†è¯¦ç»†çš„å®šä»·ä¿¡æ¯ï¼š

```python
{
    "id": "@cf/meta/llama-3.1-8b-instruct",
    "name": "Llama 3.1 8B Instruct",
    "provider": "Meta",
    "description": "Meta's Llama 3.1 8B instruction-tuned model - Latest and most capable",
    "pricing": {
        "input": 0.05,   # $ per 1M tokens
        "output": 0.05   # $ per 1M tokens
    }
}
```

### 3. æ•°æ®åº“æ¶æ„æ›´æ–°

**æ–‡ä»¶**: `server/models.py`

åœ¨ `UsageLog` è¡¨æ·»åŠ äº†ä¸¤ä¸ªæ–°å­—æ®µï¼š

- `cost_usd` (Float): å•æ¬¡è¯·æ±‚çš„å®é™…æˆæœ¬ï¼ˆç¾å…ƒï¼‰
- `model_pricing` (Text): å®šä»·ä¿¡æ¯çš„JSONå­—ç¬¦ä¸²

**æ•°æ®åº“è¿ç§»**: 
- âœ… è‡ªåŠ¨è¿ç§»è„šæœ¬: `server/migrate_db.py`
- âœ… å¤‡ä»½æ—§æ•°æ®: `app.db.backup.20251028_183007`
- âœ… å†å²æ•°æ®æˆæœ¬è®¡ç®—: æ›´æ–°äº†4æ¡ç°æœ‰è®°å½•

### 4. æˆæœ¬è®¡ç®—é€»è¾‘

**æ–‡ä»¶**: `server/cloudflare_client.py`

æ·»åŠ äº†æˆæœ¬è®¡ç®—å‡½æ•°ï¼š

```python
def calculate_cost(model_id: str, input_tokens: int, output_tokens: int) -> float:
    """Calculate cost in USD based on token usage and model pricing"""
    model = get_model_by_id(model_id)
    pricing = model['pricing']
    
    input_cost = (input_tokens / 1_000_000) * pricing['input']
    output_cost = (output_tokens / 1_000_000) * pricing['output']
    
    return round(input_cost + output_cost, 6)
```

**æµ‹è¯•ç»“æœ**: 
- 13 tokens Ã— $0.05/1M = $0.000001 âœ…

### 5. APIå“åº”æ›´æ–°

**æ–‡ä»¶**: `server/schemas.py`, `server/routers/ai_router.py`, `server/routers/usage_router.py`

#### ChatResponse æ–°å¢å­—æ®µï¼š
- `cost_usd`: å•æ¬¡è¯·æ±‚æˆæœ¬

#### UsageStats æ–°å¢å­—æ®µï¼š
- `total_cost_usd`: æ€»æˆæœ¬
- `by_model[model].cost`: æ¯ä¸ªæ¨¡å‹çš„æˆæœ¬åˆ†å¸ƒ

### 6. å‰ç«¯UIæ›´æ–°

#### A. TypeScript ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `client/src/api.ts`

```typescript
export interface ChatResponse {
    cost_usd: number;  // æ–°å¢
}

export interface UsageStats {
    total_cost_usd: number;  // æ–°å¢
    by_model: Record<string, { 
        requests: number; 
        tokens: number; 
        cost: number  // æ–°å¢
    }>;
}
```

#### B. Usage Panel æˆæœ¬æ˜¾ç¤º

**æ–‡ä»¶**: `client/src/components/UsagePanel.tsx`

**æ–°å¢å¡ç‰‡**: æ€»æˆæœ¬æ˜¾ç¤ºï¼ˆæ”¾åœ¨æœ€å‰é¢ï¼‰
```
ğŸ’° Total Cost
   $0.000001
```

**æŒ‰æ¨¡å‹æˆæœ¬åˆ†å¸ƒ**: 
- æŒ‰æˆæœ¬ä»é«˜åˆ°ä½æ’åº
- æ˜¾ç¤ºæ¯ä¸ªæ¨¡å‹çš„æˆæœ¬ã€è¯·æ±‚æ•°ã€Tokenæ•°
- æˆæœ¬å æ¯”å¯è§†åŒ–è¿›åº¦æ¡ï¼ˆçº¢è‰²ï¼‰

**æ—¥å¿—è¡¨æ–°å¢åˆ—**: Coståˆ—ï¼Œæ˜¾ç¤ºæ¯æ¬¡è¯·æ±‚çš„æˆæœ¬

#### C. Chat Panel æ”¹è¿›

**æ–‡ä»¶**: `client/src/components/ChatPanel.tsx`

**æ¨¡å‹é€‰æ‹©å™¨æ”¹è¿›**:
- âœ… æŒ‰æä¾›å•†åˆ†ç»„ï¼ˆoptgroupï¼‰
- âœ… æ˜¾ç¤ºæ¨¡å‹ä»·æ ¼: `Llama 3.1 8B ($0.05/M tok)`
- âœ… é€‰ä¸­æ¨¡å‹æ—¶æ˜¾ç¤ºè¯¦ç»†å®šä»·: `ğŸ’° $0.05/M input Â· $0.05/M output`

**æ¶ˆæ¯æ˜¾ç¤ºæ”¹è¿›**:
- âœ… AIå›å¤ä¸‹æ–¹æ˜¾ç¤ºè¯¥æ¬¡è¯·æ±‚çš„æˆæœ¬å’ŒTokenæ•°
- æ ¼å¼: `ğŸ’° $0.000001  ğŸª™ 13 tokens`

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### è‡ªåŠ¨åŒ–æµ‹è¯•

**æµ‹è¯•è„šæœ¬**: `test_cost_tracking.py`

#### æµ‹è¯•åœºæ™¯ï¼š
1. âœ… ç”¨æˆ·ç™»å½•è·å–API Key
2. âœ… è·å–15ä¸ªæ¨¡å‹åˆ—è¡¨åŠå®šä»·ä¿¡æ¯
3. âœ… æµ‹è¯•3ä¸ªä¸åŒå®šä»·çš„æ¨¡å‹ï¼š
   - Llama 3.1 8B ($0.05/M): âœ… æˆåŠŸ
   - Microsoft Phi-2 ($0.03/M): âš ï¸ Cloudflareé™åˆ¶
   - Mistral 7B v0.2 ($0.06/M): âš ï¸ Cloudflareé™åˆ¶
4. âœ… è·å–ç”¨é‡ç»Ÿè®¡ï¼ˆæ€»æˆæœ¬ã€æŒ‰æ¨¡å‹åˆ†å¸ƒï¼‰
5. âœ… æŸ¥çœ‹æˆæœ¬æ—¥å¿—

#### å®é™…æµ‹è¯•æ•°æ®ï¼š
```
ğŸ“Š è¯·æ±‚ç»Ÿè®¡:
  æ€»è¯·æ±‚æ•°: 1
  æ€» Tokens: 13 (6 input â†’ 7 output)
  ğŸ’° æ€»æˆæœ¬: $0.000001

ğŸ“Š æŒ‰æ¨¡å‹åˆ†å¸ƒ:
  â€¢ llama-3.1-8b-instruct
    æˆæœ¬: $0.000001
    è¯·æ±‚: 1
    Tokens: 13
```

### æ‰‹åŠ¨æµ‹è¯•æ¸…å•

- [ ] æ‰“å¼€å‰ç«¯: http://localhost:5173
- [ ] ç™»å½•/æ³¨å†Œè´¦æˆ·
- [ ] **Chat Panel**:
  - [ ] æŸ¥çœ‹æ¨¡å‹é€‰æ‹©å™¨åˆ†ç»„
  - [ ] é€‰æ‹©ä¸åŒæ¨¡å‹æŸ¥çœ‹å®šä»·
  - [ ] å‘é€æ¶ˆæ¯æŸ¥çœ‹AIå›å¤ä¸‹æ–¹çš„æˆæœ¬æ˜¾ç¤º
- [ ] **Usage Panel**:
  - [ ] æŸ¥çœ‹æ€»æˆæœ¬å¡ç‰‡
  - [ ] æŸ¥çœ‹æŒ‰æ¨¡å‹çš„æˆæœ¬åˆ†å¸ƒ
  - [ ] æŸ¥çœ‹æ—¥å¿—è¡¨çš„æˆæœ¬åˆ—

---

## ğŸ¨ UIæ”¹è¿›äº®ç‚¹

### æˆæœ¬å¯è§†åŒ–
1. **é†’ç›®çš„çº¢è‰²**: æˆæœ¬ç›¸å…³æ•°å­—ä½¿ç”¨`#dc2626`çº¢è‰²ï¼Œå¼•èµ·ç”¨æˆ·æ³¨æ„
2. **è¿›åº¦æ¡**: æŒ‰æ¨¡å‹æˆæœ¬åˆ†å¸ƒä½¿ç”¨çº¢è‰²è¿›åº¦æ¡ï¼Œç›´è§‚æ˜¾ç¤ºå æ¯”
3. **å®æ—¶åé¦ˆ**: æ¯æ¡AIæ¶ˆæ¯ä¸‹æ–¹ç«‹å³æ˜¾ç¤ºæˆæœ¬

### ç”¨æˆ·ä½“éªŒ
1. **æ¨¡å‹åˆ†ç»„**: æŒ‰æä¾›å•†åˆ†ç»„ï¼Œæ–¹ä¾¿ç”¨æˆ·é€‰æ‹©
2. **å®šä»·é€æ˜**: é€‰æ‹©æ¨¡å‹æ—¶æ˜¾ç¤ºè¯¦ç»†ä»·æ ¼
3. **æ’åºä¼˜åŒ–**: æŒ‰æˆæœ¬ä»é«˜åˆ°ä½æ’åºï¼Œå¸®åŠ©ç”¨æˆ·è¯†åˆ«æ˜‚è´µæ¨¡å‹
4. **ç²¾ç¡®æ˜¾ç¤º**: æˆæœ¬ç²¾ç¡®åˆ°6ä½å°æ•°ï¼ˆ$0.000001ï¼‰

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### åç«¯ (7ä¸ªæ–‡ä»¶)
1. `server/cloudflare_client.py` - æ¨¡å‹åˆ—è¡¨ã€å®šä»·ã€æˆæœ¬è®¡ç®—
2. `server/models.py` - æ•°æ®åº“æ¨¡å‹æ–°å¢å­—æ®µ
3. `server/schemas.py` - APIå“åº”schemaæ›´æ–°
4. `server/routers/ai_router.py` - è®°å½•æˆæœ¬
5. `server/routers/usage_router.py` - è¿”å›æˆæœ¬ç»Ÿè®¡
6. `server/migrate_db.py` - âœ¨ æ–°å¢ï¼šæ•°æ®åº“è¿ç§»è„šæœ¬
7. `server/.env` - é…ç½®æ–‡ä»¶ï¼ˆæ— ä¿®æ”¹ï¼‰

### å‰ç«¯ (3ä¸ªæ–‡ä»¶)
1. `client/src/api.ts` - TypeScriptç±»å‹å®šä¹‰
2. `client/src/components/UsagePanel.tsx` - æˆæœ¬æ˜¾ç¤º
3. `client/src/components/ChatPanel.tsx` - æ¨¡å‹é€‰æ‹©å™¨+æ¶ˆæ¯æˆæœ¬

### æµ‹è¯•å’Œæ–‡æ¡£
1. `test_cost_tracking.py` - âœ¨ æ–°å¢ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
2. `IMPLEMENTATION_SUMMARY.md` - âœ¨ æ–°å¢ï¼šæœ¬æ–‡æ¡£

---

## ğŸš€ éƒ¨ç½²è¯´æ˜

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

#### 1. åç«¯å¯åŠ¨
```bash
cd server
source venv/bin/activate
python main.py
```
æœåŠ¡å™¨: http://localhost:8000  
APIæ–‡æ¡£: http://localhost:8000/docs

#### 2. å‰ç«¯å¯åŠ¨
```bash
cd client
npm run dev
```
åº”ç”¨: http://localhost:5173

### ç”Ÿäº§éƒ¨ç½²

#### æ•°æ®åº“è¿ç§»
```bash
cd server
python migrate_db.py
```

#### Dockeréƒ¨ç½²
```bash
docker-compose up -d
```

---

## ğŸ’¡ æˆæœ¬ä¼˜åŒ–å»ºè®®

### ç”¨æˆ·å±‚é¢
1. **é€‰æ‹©ç»æµæ¨¡å‹**: TinyLlama ($0.01/M) é€‚åˆç®€å•ä»»åŠ¡
2. **é¿å…æ˜‚è´µæ¨¡å‹**: Mistralç³»åˆ— ($0.06/M) æœ€è´µ
3. **æŸ¥çœ‹æˆæœ¬ç»Ÿè®¡**: å®šæœŸæ£€æŸ¥Usageé¢æ¿äº†è§£æ¶ˆè´¹

### ç³»ç»Ÿå±‚é¢
1. **è®¾ç½®æˆæœ¬ä¸Šé™**: å¯ä»¥åœ¨æœªæ¥æ·»åŠ æ¯æ—¥/æ¯æœˆæˆæœ¬é™é¢
2. **é¢„ç®—è­¦å‘Š**: æ¥è¿‘é¢„ç®—æ—¶å‘é€é€šçŸ¥
3. **æˆæœ¬æŠ¥å‘Š**: ç”Ÿæˆæœˆåº¦æˆæœ¬æŠ¥å‘Š

---

## ğŸ“ˆ æœªæ¥æ”¹è¿›æ–¹å‘

### çŸ­æœŸ (1-2å‘¨)
- [ ] æ·»åŠ æˆæœ¬é¢„è­¦ï¼ˆæ¥è¿‘é™é¢æ—¶é€šçŸ¥ï¼‰
- [ ] å¯¼å‡ºæˆæœ¬æŠ¥å‘Šï¼ˆCSV/PDFï¼‰
- [ ] æˆæœ¬è¶‹åŠ¿å›¾è¡¨ï¼ˆæŒ‰å¤©/å‘¨/æœˆï¼‰

### ä¸­æœŸ (1-2æœˆ)
- [ ] å¤šç§è®¡è´¹æ–¹å¼ï¼ˆé¢„ä»˜è´¹ã€åä»˜è´¹ï¼‰
- [ ] æˆæœ¬é…é¢ç®¡ç†ï¼ˆæŒ‰ç”¨æˆ·/å›¢é˜Ÿï¼‰
- [ ] å®æ—¶æˆæœ¬ä»ªè¡¨æ¿

### é•¿æœŸ (3-6æœˆ)
- [ ] æ”¯æŒæ›´å¤šAIæä¾›å•†ï¼ˆOpenAIã€Anthropicç­‰ï¼‰
- [ ] æˆæœ¬ä¼˜åŒ–å»ºè®®ï¼ˆAIæ¨èæœ€ä½³æ¨¡å‹ï¼‰
- [ ] ä¼ä¸šçº§è®¡è´¹åŠŸèƒ½

---

## ğŸ¯ å…³é”®æˆæœ

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|-----|------|------|------|
| æ¨¡å‹æ•°é‡ | 15+ | 15 | âœ… |
| å®šä»·é…ç½® | 100% | 100% | âœ… |
| æˆæœ¬è¿½è¸ª | å®æ—¶ | å®æ—¶ | âœ… |
| UIæ›´æ–° | å…¨é¢ | 4ä¸ªç»„ä»¶ | âœ… |
| æµ‹è¯•è¦†ç›– | æ ¸å¿ƒåŠŸèƒ½ | è‡ªåŠ¨åŒ–+æ‰‹åŠ¨ | âœ… |
| æ–‡æ¡£å®Œæ•´æ€§ | è¯¦ç»† | æœ¬æ–‡æ¡£ | âœ… |

---

## ğŸ‘¥ ä½¿ç”¨ç¤ºä¾‹

### APIè°ƒç”¨
```python
# å‘é€èŠå¤©è¯·æ±‚
response = requests.post(
    "http://localhost:8000/api/ai/chat",
    headers={
        "Authorization": f"Bearer {token}",
        "X-API-Key": api_key
    },
    json={
        "messages": [{"role": "user", "content": "Hello"}],
        "model": "@cf/meta/llama-3.1-8b-instruct"
    }
)

# å“åº”åŒ…å«æˆæœ¬
result = response.json()
print(f"Cost: ${result['cost_usd']}")
print(f"Tokens: {result['total_tokens']}")
```

### å‰ç«¯ä½¿ç”¨
```typescript
// å‘é€æ¶ˆæ¯ä¼šè‡ªåŠ¨è¿½è¸ªæˆæœ¬
const response = await aiApi.chat(apiKey, {
    messages: [...],
    model: selectedModel
});

// æ¶ˆæ¯ä¸‹æ–¹è‡ªåŠ¨æ˜¾ç¤º: ğŸ’° $0.000001  ğŸª™ 13 tokens
```

---

## ğŸ› å·²çŸ¥é—®é¢˜

1. **éƒ¨åˆ†æ¨¡å‹ä¸å¯ç”¨**: 
   - Microsoft Phi-2 è¿”å›403é”™è¯¯
   - Mistral v0.2 è¿”å›400é”™è¯¯
   - **åŸå› **: Cloudflare APIé™åˆ¶æˆ–æ¨¡å‹æœªæ¿€æ´»
   - **å½±å“**: ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Œå…¶ä»–13ä¸ªæ¨¡å‹æ­£å¸¸

2. **æˆæœ¬ç²¾åº¦**:
   - ä½¿ç”¨tokenä¼°ç®—ï¼ˆtiktokenï¼‰
   - å¯èƒ½ä¸å®é™…ç•¥æœ‰å·®å¼‚
   - **å»ºè®®**: å®šæœŸä¸Cloudflareè´¦å•æ ¸å¯¹

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. APIæ–‡æ¡£: http://localhost:8000/docs
2. é¡¹ç›®README: `README.md`
3. å¿«é€Ÿå¼€å§‹: `QUICKSTART.md`

---

**å®æ–½å®Œæˆæ—¥æœŸ**: 2025-10-28  
**æ€»è€—æ—¶**: ~2å°æ—¶  
**ä»£ç è´¨é‡**: âœ… æ— Linteré”™è¯¯  
**æµ‹è¯•çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½é€šè¿‡

